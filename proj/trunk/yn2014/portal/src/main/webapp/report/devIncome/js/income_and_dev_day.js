var field=["DEV_2_CHW_NUM",    //      长话王发展量              
           "DEV_2_SHW_NUM",    //      市话王发展量              
           "DEV_2_BDW_NUM",    //      包打王发展量              
           "DEV_2_LLW_NUM",    //      流量王发展量              
           "DEV_2_JSK_NUM",    //      日租卡发展量              
           "DEV_2_OT_NUM",     //      2G其他发展量              
           "DEV_2G_NUM",       //      2G发展量   
                            //
                            //
           "DEV_3_DK_NUM",     //      3G单卡发展量              
           "DEV_3_GJSF_NUM",   //      购机送费发展量            
           "DEV_3_CFSJ_NUM",   //      存费送机发展量            
           "DEV_3_CFSF_NUM",   //      存费送费发展量            
           "DEV_3_ZBJ_NUM",    //      本省自备机发展量          
           "DEV_3_SWK_NUM",    //      上网卡发展量              
           "DEV_3_OT_NUM",     //      3G其他发展量              
           "DEV_3G_NUM",       //      3G发展量 
                            //
                            //
                            //
           "DEV_4_BDDK_NUM",   //      本地单卡发展量            
           "DEV_4_HYHJ_NUM",   //      本地套餐合约惠机发展量    
           "DEV_4_CFSF_NUM",   //      本地套餐存费送费发展量    
           "DEV_4_GJSF_NUM",   //      全国套餐购机送费发展量    
           "DEV_4_CFSJ_NUM",   //      全国套餐存费送机发展量    
           "DEV_4_HYHJ1_NUM",  //      全国套餐合约惠机发展量    
           "DEV_4_CFSF1_NUM",  //      全国套餐存费送费发展量    
           "DEV_4_OT_NUM",     //      4G其他发展量              
           "DEV_4G_NUM",       //      4G发展量  
                            //
                            //
           "DEV_ADSL_NUM",     //      ADSL发展量                
           "DEV_LAN_NUM",      //      LAN发展量                 
           "DEV_EOC_NUM",      //      EOC发展量                 
           "DEV_FTTH_NUM",     //      FTTH发展量                               
           "DEV_10M_NUM",      //      10M以上宽带发展量 
           "DEV_BB_NUM",       //      宽带发展量 
                            //
                            //
           "DEV_2_CHW_NUM1",   //      (月累计)长话王发展量      
           "DEV_2_SHW_NUM1",   //      (月累计)市话王发展量      
           "DEV_2_BDW_NUM1",   //      (月累计)包打王发展量      
           "DEV_2_LLW_NUM1",   //      (月累计)流量王发展量      
           "DEV_2_JSK_NUM1",   //      (月累计)极速卡发展量      
           "DEV_2_OT_NUM1",    //      (月累计)2G其他发展量      
           "DEV_2G_NUM1",      //      (月累计)2G发展量 
                            //
                            //
           "DEV_3_DK_NUM1",    //      (月累计)3G单卡发展量      
           "DEV_3_GJSF_NUM1",  //      (月累计)购机送费发展量    
           "DEV_3_CFSJ_NUM1",  //      (月累计)存费送机发展量    
           "DEV_3_CFSF_NUM1",  //      (月累计)存费送费发展量    
           "DEV_3_ZBJ_NUM1",   //      (月累计)本省自备机发展量  
           "DEV_3_SWK_NUM1",   //      (月累计)上网卡发展量      
           "DEV_3_OT_NUM1",    //      (月累计)3G其他发展量      
           "DEV_3G_NUM1",      //      (月累计)3G发展量 
                            //
                            //
           "DEV_4_BDDK_NUM1",  //      (月累计)本地单卡发展量    
           "DEV_4_HYHJ_NUM1",  //      (月累计)本地套餐合约惠机发展量 
           "DEV_4_CFSF_NUM1",  //      (月累计)本地套餐存费送费发展量 
           "DEV_4_GJSF_NUM1",  //      (月累计)全国套餐购机送费发展量 
           "DEV_4_CFSJ_NUM1",  //      (月累计)全国套餐存费送机发展量 
           "DEV_4_HYHJ1_NUM1", //      (月累计)全国套餐合约惠机发展量 
           "DEV_4_CFSF1_NUM1", //      (月累计)全国套餐存费送费发展量 
           "DEV_4_OT_NUM1",    //      (月累计)4G其他发展量      
           "DEV_4G_NUM1",      //      (月累计)4G发展量 
                            //
                            //
           "DEV_ADSL_NUM1",    //      (月累计)ADSL发展量        
           "DEV_LAN_NUM1",     //      (月累计)LAN发展量         
           "DEV_EOC_NUM1",     //      (月累计)EOC发展量         
           "DEV_FTTH_NUM1",    //      (月累计)FTTH发展量 
           "DEV_10M_NUM1",     //      (月累计)10M以上宽带发展量        
           "DEV_BB_NUM1",      //      (月累计)宽带发展量    
                            //
                            //
           "SR_2_CHW_NUM",     //      长话王收入                
           "SR_2_SHW_NUM",     //      市话王收入                
           "SR_2_BDW_NUM",     //      包打王收入                
           "SR_2_LLW_NUM",     //      流量王收入                
           "SR_2_JSK_NUM",     //      极速卡收入                
           "SR_2_OT_NUM",      //      2G其他收入                
           "SR_2G_NUM",        //      2G收入  
                            //
                            //
           "SR_3_DK_NUM",      //      3G单卡收入                
           "SR_3_GJSF_NUM",    //      购机送费收入              
           "SR_3_CFSJ_NUM",    //      存费送机收入              
           "SR_3_CFSF_NUM",    //      存费送费收入              
           "SR_3_ZBJ_NUM",     //      本省自备机收入            
           "SR_3_SWK_NUM",     //      上网卡收入                
           "SR_3_OT_NUM",      //      3G其他收入                
           "SR_3G_NUM",        //      3G收入   
                            //
           "SR_4_BDDK_NUM",    //      本地单卡收入              
           "SR_4_HYHJ_NUM",    //      本地套餐合约惠机收入      
           "SR_4_CFSF_NUM",    //      本地套餐存费送费收入      
           "SR_4_GJSF_NUM",    //      全国套餐购机送费收入      
           "SR_4_CFSJ_NUM",    //      全国套餐存费送机收入      
           "SR_4_HYHJ1_NUM",   //      全国套餐合约惠机收入      
           "SR_4_CFSF1_NUM",   //      全国套餐存费送费收入      
           "SR_4_OT_NUM",      //      4G其他收入                
           "SR_4G_NUM",        //      4G收入    
                             //
           "SR_ADSL_NUM",      //      ADSL收入                  
           "SR_LAN_NUM",       //      LAN收入                   
           "SR_EOC_NUM",       //      EOC收入                   
           "SR_FTTH_NUM",      //      FTTH收入     
           "SR_10M_NUM",       //      10M以上宽带收入             
           "SR_BB_NUM",        //      宽带收入    
                             //
           "DEV_ZZX_NUM",      //      专租线（不含ICT）发展量              
           "DEV_ZZX_NUM1",     //      (月累计)专租线发展量      
           "SR_ZZX_NUM",       //      专租线（不含ICT）收入               
           "DEV_NET_NUM",      //      当日发展量
           "DEV_NET_NUM1",	   //	        累计发展
           "SR_NET_NUM"];      //      固话收入
var orderBy='';	
$(function(){
	
	var sumSql=getSumSql(field);
	
	
	var report=new LchReport({
		title:[["营销架构","2G当日发展","","","","","","","3G当日发展","","","","","","","","4G当日发展","","","","","","","","","固网宽带当日发展","","","","","","2G累计发展","","","","","","","3G累计发展","","","","","","","","4G累计发展","","","","","","","","","固网宽带累计发展","","","","","","2G累计收入","","","","","","","3G累计收入","","","","","","","","4G累计收入","","","","","","","","","固网宽带累计收入","","","","","","集客专租线发展","","专租线收入","固话发展量","","固话收入"],
		       ["","长话王","市话王","包打王","流量王","日租卡","其他","合计","单卡","购机送费","存费送机","存费送费","本省自备机","上网卡","其他","合计","本地单卡","本地套餐合约惠机","本地套餐存费送费","全国套餐购机送费","全国套餐存费送机","全国套餐合约惠机","全国套餐存费送费","其他","合计","ADSL","LAN","EOC","FTTH","其中10M及以上","合计","长话王","市话王","包打王","流量王","日租卡","其他","合计","单卡","购机送费","存费送机","存费送费","本省自备机","上网卡","其他","合计","本地单卡","本地套餐合约惠机","本地套餐存费送费","全国套餐购机送费","全国套餐存费送机","全国套餐合约惠机","全国套餐存费送费","其他","合计","ADSL","LAN","EOC","FTTH","其中10M及以上","合计","长话王","市话王","包打王","流量王","日租卡","其他","合计","单卡","购机送费","存费送机","存费送费","本省自备机","上网卡","其他","合计","本地单卡","本地套餐合约惠机","本地套餐存费送费","全国套餐购机送费","全国套餐存费送机","全国套餐合约惠机","全国套餐存费送费","其他","合计","ADSL","LAN","EOC","FTTH","其中10M及以上","合计","当日发展","累计发展","累计收入","当日发展","累计发展",""]]
		,
		field:["ROW_NAME"].concat(field),
		css:[{gt:0,css:LchReport.RIGHT_ALIGN}],
		rowParams:["ROW_ID","PER_TYPE"],//第一个为rowId
		content:"lchcontent",
		orderCallBack:function(index,type){
			if(index==0){
				orderBy=" order by row_name "+type+" ";
			}else if(index>0){
				orderBy=" order by "+field[index-1]+" "+type+" ";
			}
			report.showSubRow();
		},
		getSubRowsCallBack:function($tr){
			if($tr&&$tr.attr("orgLevel")==4){
				showAgentList($tr);
				return null;
			}
			
			
			var preField='';
			var where='';
			var groupBy='';
			var code='';
			var orgLevel='';
			var qdate = $.trim($("#month").val());
			
			var provinceSql="";
			if($tr){
				code=$tr.attr("row_id");
				orgLevel=parseInt($tr.attr("orgLevel"));
				var parentId=$tr.attr("parentId");
				
				if(orgLevel==2){//点击市
					preField=' t.unit_id ROW_ID,t.unit_name ROW_NAME';
					groupBy=' group by t.unit_id,t.unit_name ';
					where=' where t.GROUP_ID_1=\''+code+"\' ";
				}else if(orgLevel==3){//点击营服中心
					preField=" t.AGENT_M_USERID ROW_ID,t.AGENT_M_NAME||'('|| case t.PER_TYPE when '1' then '客户经理' when '2' then '渠道经理' else '小区经理' end ||')' ROW_NAME,t.PER_TYPE ";
					groupBy=' group by t.AGENT_M_USERID,t.AGENT_M_NAME,t.PER_TYPE ';
					where=' where t.unit_id=\''+code+"\' ";
				}else if(orgLevel>=4){//点击渠道经理
					preField=' t.group_id_4 ROW_ID,t.group_id_4_name ROW_NAME ';
					groupBy=' group by t.group_id_4,t.group_id_4_name ';
					if(code=='undefined'){
						where=' where t.AGENT_M_USERID is null and t.unit_id=\''+parentId+'\' ';
					}else{
						where=' where t.AGENT_M_USERID=\''+code+'\' and t.unit_id=\''+parentId+'\' ';
					}
				}else{
					return {data:[],extra:{}};
				}
				orgLevel++;
			}else{
				//先根据用户信息得到前几个字段
				code=$("#code").val();
				orgLevel=$("#orgLevel").val();
				if(orgLevel==1){//省
					preField=' t.group_id_1 ROW_ID,t.group_id_1_name ROW_NAME';
					groupBy=' group by t.group_id_1,t.group_id_1_name ';
					where=' where t.GROUP_ID_0=\''+code+"\' ";
					orgLevel=2;
					
					provinceSql=' union all select t.group_id_0 ROW_ID,\'全省合计\' ROW_NAME,'+sumSql+' from PMRT.TAB_MRT_TARGET_CH_DAY partition(P'+qdate+') t ';
					provinceSql+=' where t.GROUP_ID_0=\''+code+'\'  ';
					provinceSql+=' group by t.group_id_0 ';
				}else if(orgLevel==2){//市
					preField=' t.group_id_1 ROW_ID,t.group_id_1_name ROW_NAME';
					groupBy=' group by t.group_id_1,t.group_id_1_name ';
					where=' where t.GROUP_ID_1=\''+code+"\' ";
				}else if(orgLevel==3){//营服中心
					preField=' t.unit_id ROW_ID,t.unit_name ROW_NAME';
					groupBy=' group by t.unit_id,t.unit_name ';
					where=' where t.unit_id=\''+code+"\' ";
				}else if(orgLevel>=4){//
					preField=' t.group_id_4 ROW_ID,t.group_id_4_name ROW_NAME';
					groupBy=' group by t.group_id_4,t.group_id_4_name ';
					where=' where t.GROUP_ID_4=\''+code+"\' ";
				}else{
					return {data:[],extra:{}};
				}
			}	
			var sql='select '+preField+','+sumSql+' from PMRT.TAB_MRT_TARGET_CH_DAY partition(P'+qdate+') t ';
			
			/*if(where!=''&&qdate!=''){
				where+=' and  t.DEAL_DATE='+qdate+' ';
			}*/
			if(where!=''){
				sql+=where;
			}
			if(groupBy!=''){
				sql+=groupBy;
			}
			if(provinceSql!=""){
				sql+=provinceSql;
			}
			if(orderBy!=''){
				sql="select * from( "+sql+") t "+orderBy;
			}
			var d=query(sql);
			
			return {data:d,extra:{orgLevel:orgLevel}};
		}
	});
	report.showSubRow();
	report.showAllCols(0);
///////////////////////////////////////////
	//$("#lch_DataHead").find("TH").unbind();
	//$("#lch_DataHead").find(".sub_on,.sub_off,.space").remove();
	///////////////////////////////////////////
	$("#searchBtn").click(function(){
		report.showSubRow();
		report.showAllCols(0);
///////////////////////////////////////////
		//$("#lch_DataHead").find("TH").unbind();
		//$("#lch_DataHead").find(".sub_on,.sub_off,.space").remove();
		///////////////////////////////////////////
	});
});
function getSumSql(field){
	var s="";
	for(var i=0;i<field.length;i++){
		if(s.length>0){
			s+=",";
		}
		s+="SUM(t."+field[i]+") "+field[i];
	}
	return s;
}
/**
 * 查看渠道经理下的渠道列表
 * @param 
 * @return
 */
function showAgentList($tr){
	var agentId=$tr.attr("row_id");
	var unitId=$tr.attr("parentId");
	var $unit=$("#lch_DataBody").find("TR[row_id='"+unitId+"']");
	var perType=$tr.attr("PER_TYPE");
	var month = $.trim($("#month").val());
	var text=$unit.find("TD:eq(0)").find("A:eq(0)").text()+"->"+$tr.find("TD:eq(0)").find("A:eq(0)").text();
	var url=$("#ctx").val()+"/report/devIncome/jsp/income_and_dev_day_list.jsp?agentId="+agentId+"&unitId="+unitId+"&month="+month+"&agentType="+perType;
	window.parent.openWindow(text,null,url);
}
/////////////////////////下载开始/////////////////////////////////////////////
function downsAll() {
	var qdate = $.trim($("#month").val());
	
	var preField=' t.group_id_1_name,t.unit_name,t.agent_m_name,case t.PER_TYPE when \'1\' then \'客户经理\' when \'2\' then \'渠道经理\' else \'小区经理\' end  PER_TYPE ,t.HR_ID,t.group_id_4_name,t.state,t.HQ_CHAN_CODE,t.DEAL_DATE ';
	var where='';
	var orderBy=" order by t.group_id_1_name,t.unit_name,t.agent_m_name,t.PER_TYPE ,t.HR_ID,t.group_id_4_name,t.HQ_CHAN_CODE,t.DEAL_DATE ";
	var fieldSql=field.join(",");
	//先根据用户信息得到前几个字段
	var code = $("#code").val();
	var orgLevel = $("#orgLevel").val();
	if (orgLevel == 1) {//省
		where = " where t.GROUP_ID_0='" + code + "' ";
	} else if (orgLevel == 2) {//市
		where = " where t.GROUP_ID_1='" + code + "' ";
	} else if (orgLevel == 3) {//营服中心
		where = " where t.unit_id='" + code + "' ";
	} else if (orgLevel >= 4) {//
		where = " where t.GROUP_ID_4='" + code + "' ";
	}
	/*if(where!=''&&qdate!=''){
		where+=' and  t.DEAL_DATE='+qdate+' ';
	}*/

	var sql = 'select ' + preField + ',' + fieldSql
			+ ' from PMRT.TAB_MRT_TARGET_CH_DAY partition(P'+qdate+')  t ';
	if (where != '') {
		sql += where;
	}
	if(orderBy!=''){
		sql="select * from( "+sql+") t "+orderBy;
	}
	
	showtext = '用户发展收入日报-' + qdate;
	var title=[["营销架构","","","","","","","","日期","2G当日发展","","","","","","","3G当日发展","","","","","","","","4G当日发展","","","","","","","","","固网宽带当日发展","","","","","","2G累计发展","","","","","","","3G累计发展","","","","","","","","4G累计发展","","","","","","","","","固网宽带累计发展","","","","","","2G累计收入","","","","","","","3G累计收入","","","","","","","","4G累计收入","","","","","","","","","固网宽带累计收入","","","","","","集客专租线发展","","专租线收入","固话发展量","","固话收入"],
	           ["地市","营服中心","人员","类型","HR编码","渠道（小区）名称","渠道（小区）状态","渠道（小区）编码","","长话王","市话王","包打王","流量王","日租卡","其他","合计","单卡","购机送费","存费送机","存费送费","本省自备机","上网卡","其他","合计","本地单卡","本地套餐合约惠机","本地套餐存费送费","全国套餐购机送费","全国套餐存费送机","全国套餐合约惠机","全国套餐存费送费","其他","合计","ADSL","LAN","EOC","FTTH","其中10M及以上","合计","长话王","市话王","包打王","流量王","日租卡","其他","合计","单卡","购机送费","存费送机","存费送费","本省自备机","上网卡","其他","合计","本地单卡","本地套餐合约惠机","本地套餐存费送费","全国套餐购机送费","全国套餐存费送机","全国套餐合约惠机","全国套餐存费送费","其他","合计","ADSL","LAN","EOC","FTTH","其中10M及以上","合计","长话王","市话王","包打王","流量王","日租卡","其他","合计","单卡","购机送费","存费送机","存费送费","本省自备机","上网卡","其他","合计","本地单卡","本地套餐合约惠机","本地套餐存费送费","全国套餐购机送费","全国套餐存费送机","全国套餐合约惠机","全国套餐存费送费","其他","合计","ADSL","LAN","EOC","FTTH","其中10M及以上","合计","当日发展","累计发展","累计收入","当日发展","累计发展",""]]
	downloadExcel(sql,title,showtext);
}
////////////////////////////////////////////////////////////////////////